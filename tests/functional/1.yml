version: '3'
services:
  fastapi:
    build: ../../
    image: fastapi:0.88.0
    env_file:
      # - ../../fastapi/.env
      - ../../tests/functional/.env
    depends_on:
      - redis
      - elasticsearch

  elasticsearch:
    image: elasticsearch:7.9.1
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - /opt/elasticsearch/data
    ports:
      - 9200:9200

  redis:
    image: redis:7.0.6-alpine
    command: redis-server
    ports:
      - "6379:6379"

  tests:
    build:
      context: ../../
      dockerfile: tests/functional/Dockerfile
    entrypoint: >
      sh -c "python3 functional/utils/wait_for_es.py
      && python3 functional/wait_for_redis.py
      && pytest src"
    depends_on:
      - fastapi


    # entrypoint: >
    #   sh -c "python3 /tests/functional/utils/wait_for_es.py
    #   && python3 tests/functional/utils/wait_for_redis.py
    #   && pytest  src"
  # tests:
  #   container_name: func-tests
  #   image: fastapi:0.88.0
  #   working_dir: /usr/src/ #tests/functional/src/
  #   # volumes:
  #   #   - ../../tests:/usr/src/tests
  #   entrypoint: >
  #     sh -c "pip install -r /tests/functional/requirements.txt
  #     && python3 /tests/functional/utils/wait_for_es.py
  #     && python3 /tests/functional/utils/wait_for_redis.py
  #     && pytest /tests/functional/src/"

    # && python3 /usr/src/tests/functional/utils/wait_for_es.py
      # && python3 /usr/src/tests/functional/utils/wait_for_redis.py
      # && pytest /tests/functional/src/"
    # && pytest /tests/functional/src/"
      # && pytest /tests/functional/src/"
    # depends_on:
    #   - elasticsearch
    #   - fastapi

# volumes:
#   postgres_volume:
#   static_volume:
#   media_volume:

